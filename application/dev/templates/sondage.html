{% extends 'base.html' %}
{% block styles %}
{{ super() }}
<link rel="stylesheet" href="{{url_for('static',filename='css/sondage.css')}}">
{% endblock %}
{% block content %}
<h1>Sondage</h1>
<h2>Sondage en cours</h2>
<table>
    <tr>
        <th>Sujet sondage</th>
        <th>Date</th>
        <th>Temps restant</th>
        <th>Vote</th>
        {% if liste_tutele %}
        <th>Repondre en tant que ...</th>
        {% endif %}
        <th>Valider</th>
    </tr>
    {% if len(sondages)==0 %}
</table>
<p>Pas de sondage en cours</p>
{% else %}
{% for s in sondages %}
<form method="POST" action="{{ url_for('validation_sondage')}}">
    <tr>
        <td>{{ s.message }}</td>
        <td>
            {% if s.idSortie!=None %}
            {{ get_sortie_by_id(s.idSortie).dateSortie }}
            {% elif s.idRepetition!=None %}
            {{ get_repetition_by_id(s.idRepetition).dateRepetition }}
            {% else %}
            <p>aucune</p>
            {% endif %}
        </td>
        <td id="temps{{s.idSondage}}">
            {{s.temps_restant()}}
        </td>
        <td>
            {% if s.idSortie==None and s.idRepetition==None %}
            <div>aucune</div> 
            {% else %}
            <div>
                <input type="radio" value="True" name="choix{{s.idSondage}}" id="oui">
                <label for="oui">oui</label>
            </div>
            <div>
                <input type="radio" value="False" name="choix{{s.idSondage}}" id="non">
                <label for="non">non</label>
            </div>
            {% endif %}
        </td>
        <input name="idsondage" type="text" value="{{s.idSondage}}" hidden>
        {% if liste_tutele %}
        <td>
            <select name="idMusicien">
                <option value="{{current_user.idMusicien}}">{{current_user.nomMusicien}} {{current_user.prenomMusicien}}</option>
                {% for m in liste_tutele %}
                {% if ((s.idSortie==None and s.idRepetition!=None) and get_participation_by_musicien_and_repetition(m.idMusicien,s.idRepetition)) or ((s.idRepetition==None and s.idSortie!=None) and get_participation_by_musicien_and_sortie(m.idMusicien,s.idSortie)) %}
                <option value="{{m.idMusicien}}" disabled>{{m.nomMusicien}} {{m.prenomMusicien}}</option>
                {% else %}
                <option value="{{m.idMusicien}}">{{m.nomMusicien}} {{m.prenomMusicien}}</option>
                {% endif %}
                {% endfor %}
            </select>
        </td>
        {% endif %}
        <td>
            {% if s.idSortie==None and s.idRepetition==None %}
            <div><a  class = "reponse" href="/page_reponse_question/{{get_question_by_idSondage(s.idSondage).idQuestion}}">repondre</a></div> 
            {% else %}
            <input class="valid" type="submit" value="✔️">
            {% endif %}
        </td>

    </tr>
</form>
<script>
    function updateContent(idSondage) {
        var xhr = new XMLHttpRequest();
        xhr.open('GET', '/update_temps' + idSondage);
            xhr.onload = function() {
                if (xhr.status === 200) {
                    var response = JSON.parse(xhr.responseText);
                    document.getElementById('temps'+idSondage).innerHTML = response.content;
                }
            };
            xhr.send();
        }
    
        setInterval(function(){updateContent({{s.idSondage}})}, 1000);
    </script>
    {% endfor %}
    </table>
    {% endif %}

{% if liste_tutele %}
<h2>Sondage répondu par :</h2>
<form action="{{url_for('page_sondage')}}" method="post">
<select name="idMusicienSondage" onchange="changementMusicien()">
    <option value="{{current_user.idMusicien}}">{{current_user.nomMusicien}} {{current_user.prenomMusicien}}</option>
    {% for m in liste_tutele %}
    <option value="{{m.idMusicien}}">{{m.nomMusicien}} {{m.prenomMusicien}}</option>
    {% endfor %}
</select>
<input type="submit" value="Changer">
</form>

</div>
{% else %}
<h2>Sondage répondu</h2>
{% endif %}

<table>
    <tr>
        <th>Sujet sondage</th>
        <th>Date</th>
        <th>Choix vote</th>
        <th>Date vote</th>
        <th>Annuler</th>
    </tr>
    {% if len(participation)==0 %}
    </table>
    <p>Pas de sondage repondu</p>
    {% else %}
    {% for ps in participation %}
    <tr>
        <td>
            {% if ps.idRepetition!=None or ps.idSortie!=None %}
                {{ ps.message }}
            {% else %}
                {{ get_question_by_idSondage(ps.idSondage).intitule }}
            {% endif %}
        </td>
        <td>
            {% if ps.idSortie!=None %}
                {{ get_sortie_by_id(ps.idSortie).dateSortie }}
            {% elif ps.idRepetition!=None%}
                {{ get_repetition_by_id(ps.idRepetition).dateRepetition }}
            {% else %}
                {{ get_question_by_idSondage(ps.idSondage).get_date_fin()}}
            {% endif %}
        </td>
        {% if ps.idSortie!=None %}
            {% if get_participation_by_musicien_and_sortie(idActuelle,ps.idSortie)[0].presence %}
                <td>oui</td>
            {% else %}
                <td>non</td>
            {% endif %}
        {% elif ps.idRepetition!=None %}
            {% if get_participation_by_musicien_and_repetition(idActuelle,ps.idRepetition)[0].presence %}
                <td>oui</td>
            {% else %}
                <td>non</td>
            {% endif %}
        {% else %}
            <td>
                <a href="/Sondage/verif_reponse/{{get_question_by_idSondage(ps.idSondage).idQuestion}}">voir</a>
            </td>
        {% endif %}
        <td>
            {% if ps.idSortie!=None %}
                {{ get_participation_by_musicien_and_sortie(idActuelle,ps.idSortie)[0].dateReponse }}
            {% elif ps.idRepetition!=None%}
                {{ get_participation_by_musicien_and_repetition(idActuelle,ps.idRepetition)[0].dateReponse }}
            {% else %}
                {{ get_reponse_by_id(get_question_by_idSondage(ps.idSondage).idQuestion,idActuelle).dateReponse}}
            {% endif %}
        </td>
        <td>
            <form method="POST" action="{{url_for('annuler_sondage')}}">
                <input type="text" name="idsondage" value="{{ps.idSondage}}" hidden>
                <input type="text" name="idMusicien" value="{{idActuelle}}" hidden>
                <input type="submit" value="✖️" class="annul">
            </form>
        </td>
    </tr>
    {% endfor %}
</table>
{% endif %}
<script>
    function changementMusicien() {
        var xhr = new XMLHttpRequest();
        xhr.open('POST', '/');
        xhr.
            xhr.onload = function() {
                if (xhr.status === 200) {
                    var response = JSON.parse(xhr.responseText);
                    document.getElementById('temps'+idSondage).innerHTML = response.content;
                }
            };
            xhr.send(JSON.stringify({idMusicien:document.getElementsByName('idMusicienSondage')[0].value}));
        }
</script>


{% endblock %}
